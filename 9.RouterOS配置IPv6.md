## 0.前景提要

在之前的文章的，RouterOS 已经可以使用 IPv4 网络正常上网。  

在 RouterOS v7.4 到 v7.5 这几个版本中，Mikrotik 官方对 IPv6 相关功能做了许多优化，是时候来配置 IPv6 网络了。  

根据 Mikrotik 官方文档，目前 RouterOS 能比较好的支持以 `SLAAC` 方式来配置 IPv6 ，而 DHCPv6 暂时只支持通告前缀信息，而不能分发地址。  

而且经过我的测试，如果把公网 IPv6 前缀信息通告到内网设备（即让内网设备直接具有公网 IPv6 地址），当 PPPoE 重新拨号或其他原因导致该公网 IPv6 前缀发生变化时，内网设备虽然也能同步获取新的公网 IPv6 地址，但此时 RouterOS 的 IPv6 路由表已经自动刷新，导致新旧公网 IPv6 地址并存的内网设备无法通过 IPv6 正常上网，只能通过重启该内网设备的网卡，让该内网设备刷新公网 IPv6 地址（等价于去掉旧的公网 IPv6 地址），才能恢复 IPv6 的网络访问。  

根据抓取 RouterOS 和 OpenWrt 的 `ICMPv6` 相关包可以发现，RouterOS 的 `Neighbor Discovery` 功能目前不支持通告 `ICMPv6 Option` 为 `Type: Route Information (24)` 的信息。而且 OpenWrt 在公网 IPv6 前缀发生变化时，除了会通告新的 IPv6 路由信息外，也会在系统 IPv6 路由表中新增路由条目，而旧的 IPv6 条目并不会删除，直到 OpenWrt 系统重启。  

总体而言， OpenWrt 对 IPv6 的支持就目前来说是好于 RouterOS 的，毕竟现在 OpenWrt 对 DHCPv6 也有良好的支持。  

鉴于以上种种约束条件的限制，本文章中的设置内容主要以 `SLAAC` 模式来分配 IPv6 地址，并加入了 `NAT66` 的防火墙，内网设备均使用 `ULA (Unique Local IPv6 Unicast Addresses)` IPv6 地址，通过地址转换来访问 IPv6 网络。

## 1.获取IPv6前缀

在之前的文章《[4.系统参数调整](./4.系统参数调整.md)》中，我们曾关闭了 IPv6 相关功能，此时需要将其打开。  

打开 Winbox 并点击左侧导航 `IPv6` 菜单的子菜单 `Settings` 。  

取消勾选 `Disable IPv6` ，并将 `Max Neighbor Entries` 参数（相当于 ARP 表最大条目数）修改为合适的数值，演示为 `1024` ：

![打开IPv6选项](img/p9/wb_ipv6_reopen.png)

点击左侧导航 `IPv6` 菜单的子菜单 `DHCP Client` ，点击“添加”按钮：

![创建DHCPv6客户端](img/p9/wb_dhcpv6_client.png)

|参数|值|说明|
|--|--|--|
|Interface|`pppoe-out1`|从 PPPoE 拨号中获取 IPv6 前缀|
|Request|`prefix`|表示只获取前缀信息|
|Pool Name|`Local_Pool_GUA_IPv6`|设置 IPv6 地址池名称|
|Use Peer DNS| **取消勾选** |不使用运营商的 IPv6 DNS|
|Add Default Route| **取消勾选** |是否加入默认路由，建议是无需勾选|
|Comment|`defconf: DHCPv6 on PPPoE`|备注信息|

 **说明：**  
 **对于 `Add Default Route` 参数，官方建议是无需勾选。**   
 **也没有相关的 RFC 文档说明 `DHCPv6 Client` 需要添加默认路由，此处存在该设置应该是 RouterOS 独特的 “快捷设置” 方法。**   
 **经过测试，该选项勾选与否均不影响后续的设置以及 IPv6 的网络访问；同时也无法解决公网 IPv6 前缀变化后，内网设备具有旧公网 IPv6 地址而无法上网的问题。**   

`DHCPv6 Client` 创建完成后，如果正确获取到了 IPv6 前缀信息，将如图所示：

![获得IPv6前缀](img/p9/wb_got_prefix.png)

如果未获取到前缀信息，需要让 PPPoE 重新拨号。  

如果重新拨号后，仍未获取 IPv6 的前缀信息，那么可能运营商并未提供 IPv6 接入的能力。  

## 2.设置接口IPv6地址

在给内部接口设置公网 IPv6 地址时，拨号的接口 `pppoe-out1` 是 **无需** 分配公网 IPv6 地址的。  

只需要给内网的网桥接口 `bridge1` 分配一个公网 IPv6 地址，并附加一个私有 ULA IPv6 地址即可。  

 **说明：**   
 **当前 RouterOS IPv6 还未设置防火墙，给内部接口分配公网 IPv6 之后，RouterOS 相当于已经与公网互联。**   
 **如果当前 RouterOS 有不完善的安全设置（比如使用了弱登录密码），系统存在被入侵的风险。**   
 **因此建议先关闭 `DHCPv6 Client` ，直到 RouterOS IPv6 防火墙等内容设置完成后，再将其打开。**   

### 2.1.给网桥接口分配公网IPv6地址

点击 Winbox 左侧导航 `IPv6` 菜单的子菜单 `Addresses` ，点击“添加”按钮：

![添加接口公网IPv6](img/p9/wb_add_gua_ipv6.png)

|参数|值|说明|
|--|--|--|
|Address|`::1/64`|自动匹配前缀，前缀长度为 `/64` ，并使用顺序第一个地址|
|From Pool|`Local_Pool_GUA_IPv6`|选择 `DHCPv6 Client` 中创建的地址池|
|Interface|`bridge1`|选择内部网桥接口|
|Advertise| **取消勾选** |如果勾选该选项，内网设备将生成公网 IPv6 地址|
|Comment|`defconf: Local LAN GUA IPv6 Address`|备注信息|

### 2.2.给网桥接口分配私有IPv6地址

根据 [RFC-4193](https://www.rfc-editor.org/rfc/rfc4193) 中给出的定义，IPv6 的私有地址 ULA 前缀为 `FC00::/7` 。  

该前缀包含 `FC00::/8` 和 `FD00::/8` 两个部分，严格意义上 ULA 目前应该使用 `FD00::/8` 。  

方便起见，本文使用 `FC00::/7` 作为演示。  

在实际使用场景下，建议使用类似 [RFC4193 IPv6 Generator](https://cd34.com/rfc4193/) 的工具来生成符合规范的 ULA 地址。

该工具只需要输入接口（例如 RouterOS 的 `bridge1` ）的 MAC 地址即可，演示如下：

![输入接口mac地址](img/p9/ula_from_mac.png)

得到符合规范的 ULA 为：

![真实IPv6ULA地址](img/p9/ula_real.png)

回到 Winbox ，再次点击“添加”按钮：

![添加接口私有IPv6](img/p9/wb_add_ula_ipv6.png)

