## 0.前景提要

在上一篇教程《[1.定义网络接口和基础配置](./1.定义网络接口和基础配置.md)》中，我们已经配置好了 RouterOS 的网络接口、DHCP、DNS等内容；  

此时，连接上 RouterOS 的设备可以正常获取到 IPv4 地址，但还不能正常访问外网。  

因为此时的 RouterOS 不仅关闭了 PPPoE 连接，而且还没有配置必要的防火墙设置。

## 1.工具准备

防火墙和流量整形的配置较为复杂，推荐使用 SSH 工具在 RouterOS 的命令行环境下进行配置。  

我目前常用的 SSH 工具是 [Tabby](https://github.com/Eugeny/tabby)，是一个基于 Electron 开发的开源跨平台终端工具，可以在 Github 平台上进行下载。

![Tabby终端工具](img/p2/tabby_terminal.png)

如果因为网络环境原因无法下载该软件时， Windows 系统自带的终端工具 `PowerShell` 也能一用。  

只需要在系统自带搜索中搜索“PowerShell”即可：

![PowerShell终端工具](img/p2/powershell_terminal.png)

打开一个终端工具，输入以下命令：

![登录RouterOS终端](img/p2/cli_login_routeros.png)

```bash
## SSH 连接 RouterOS
ssh admin@172.16.1.1

## 询问是否保存秘钥
yes
```

然后输入 RouterOS 的密码进行登录。  

输入密码时不会有输入内容的提示，密码输入完后直接回车即可。登录成功后如图所示：

![RouterOS终端登录完成](img/p2/cli_login_done.png)


## 2.定义接口组

在配置防火墙之前，需要定义接口组。接口组可以简化防火墙的配置，并且在后续使用 RouterOS 的过程中如果对接口进行了修改而不必更新防火墙条目。  

在之前的教程中已经设置好的接口有 `pppoe-out1` 、`bridge1` 和 `ether1` ，分别代表连接互联网的接口 `WAN`、内网接口 `LAN` 以及访问光猫接口 `MODEN` 。  

### 2.1.RouterOS 拨号时

 **对于使用 RouterOS 拨号的场景** ，将以下命令一次性全部粘贴到终端工具中即可：

```bash
/interface list
add name=WAN comment="defconf: Connect To Global"
add name=LAN comment="defconf: Local Bridge"
add name=MODEM comment="modemconf: Access To Modem"

/interface list member
add interface=pppoe-out1 list=WAN comment="defconf: Connect To Global"
add interface=bridge1 list=LAN comment="defconf: Local Bridge"
add interface=ether1 list=MODEM comment="modemconf: Access To Modem"
```

如果这段代码不好复制，请查阅文件 [Fox_ROS_Define_Interfaces.conf](./src/Fox_ROS_Define_Interfaces.conf) 进行复制。  

在复制粘贴命令到终端工具并执行时，有时候会出现 **光标** 停留在全部命令的 **“最后一行”** 的情况：

![光标停留在最后一行](img/p2/cli_last_line.png)

这种情况下，命令的 **“最后一行”** 其实并未执行，我们需要手动按下 **“回车”** 键（多按几次当然也可以），以保证命令的全部执行，**该方法后文部分将不再赘述** ：

![命令执行完成](img/p2/cli_exc_done.png)


### 2.2.光猫拨号时

 **对于使用光猫拨号的场景** ，则 `ether1` 为 `WAN` ，则应该使用以下命令：

```bash
/interface list
add name=WAN comment="defconf: Connect To Global"
add name=LAN comment="defconf: Local Bridge"

/interface list member
add interface=ether1 list=WAN comment="defconf: Connect To Global"
add interface=bridge1 list=LAN comment="defconf: Local Bridge"
```

命令执行完毕后，打开 Winbox 并点击左侧导航的 `Interfaces` ，切换到 `Interface List` 选项卡，查看接口组内容：

![检查接口组](img/p2/wb_check_Interface_list.png)

其中 `pppoe-out1` 显示为斜体，这是因为该接口此时处于“禁用状态”，无需担心。


## 3.配置防火墙

防火墙配置内容包括 `address-list` 、`filter` 、`nat` 、`mangle` 、`raw` 以及一些和防火墙相关的系统参数。  

防火墙的配置命令是基于 RouterOS 官方 Wiki 中有关 IPv4 [高级防火墙设置](https://help.mikrotik.com/docs/display/ROS/Building+Advanced+Firewall) 经过少许修改而来，尽可能的保证了和官方文档的一致性。  

同样是复制防火墙配置命令，一次性全部粘贴到终端工具中即可 **“一键配置”** 完成。  

 **需要注意的是，防火墙配置命令中的部分 IPv4 地址，需要根据实际情况进行调整。**   

- 光猫的 IPv4 地址 `192.168.100.1`
- RouterOS 的 IPv4 地址 `172.16.1.1`
- 内网自建 DNS 的 IPv4 地址 `172.16.1.2` 、 `172.16.1.3`
  - （后续教程将记录使用 `Adguard Home` 作为内网 DNS 服务器的过程）

分别需要修改 `address-list` 表中的 `modem_ipv4` 、 `local_subnet_ipv4` 、 `local_dns_ipv4` 这几个地址参数；以及 `nat` 表中的 DNS `redirect` 部分。  

由于防火墙的配置命令很长，因此请查阅文件 [Fox_ROS_Firewall_IPv4.conf](./src/Fox_ROS_Firewall_IPv4.conf) 进行复制。  

![防火墙配置命令](img/p2/cli_firewall.png)  

再次回到 Winbox，点击左侧导航 `IP` 菜单的子菜单 `Firewall` 并查看防火墙各个选项卡中内容：

![检查防火墙](img/p2/wb_check_firewall.png)  

确认防火墙条目与命令中的条目一致后，便可在 `Interfaces` 中启用 `pppoe-out1` 的拨号：  

![激活PPPoE拨号](img/p2/wb_enable_pppoe.png)

拨号后，`pppoe-out1` 前面的状态显示为 `R` ，则表示拨号已经成功：

![PPPoE拨号成功](img/p2/wb_pppoe_ok.png)

此时打开电脑浏览器，对您常用的网站进行访问，如果能正确访问到，表示设置成功。


## 4.配置流量整形

### 4.1.取舍快速通道与流量整形

可能细心的小伙伴已经察觉到，在防火墙中有个非常重要功能没有打开，那就是 RouterOS 的 `Fasttrack` 功能。

![Fasttrack为关闭状态](img/p2/wb_fasttrack_off.png)

这个功能的作用是跟踪已经建立的连接，并让这些流量走 **“快速通道”** 来降低设备 CPU 使用率。  

但 RouterOS 在使用流量整形时，会使用到 `Simple Queues` 功能，而 `Fasttrack` 为启用状态时，会使 `Simple Queues` 、 `Queue Tree` 等队列功能失效。  

对于如何取舍 `Fasttrack` 和 `Simple Queues` ，我提供这么几个思路：  

- 如果使用的是 CPU 较弱的硬路由（比如 `RB750Gr3` ），请选择开启 `Fasttrack`
- 如果路由器 CPU 资源已达上限，在测速时仍无法跑满带宽，请选择开启 `Fasttrack`
- 如果路由器在配置了流量整形后，在测速时反而无法跑满带宽，请选择开启 `Fasttrack`

经过我的测试，N5105 主机在我的互联网小水管带宽下性能足够，因此我选择关闭 `Fasttrack` 并启用了 `Simple Queues` 功能。  

保证了在路由器高流量负责下，看视频、打游戏仍能保持在较低的延迟水平。  

### 4.2.确定带宽上限

在执行配置命令之前，有一个十分重要的指标需要依托真实网络环境实测得出，那就是当前外网的 **实际带宽** 。  

目前国内运营商给用户的带宽一般会存在 20% 左右的余量，即如果您的宽带签约值为 `500Mbps` ，那么实际测速可能到达 `600Mbps` 左右，而且家用上下行的带宽并不对等， `500Mbps` 的下行带宽运营商可能只会给 `30~50Mbps` 的上行带宽。  

而我们常遇到，当下行带宽跑满时，比如使用下载程序下载学习资料，此时其他网络用户在看在线视频或者打网络游戏时就会遇到延迟上升，甚至卡顿，这个现象在上行带宽跑满时尤为明显。  

简单来说，这是因为内网设备对带宽的大量占用，触发了运营商的 QoS ，也就是运营商的限速，再加上数据包拥塞等一系列原因导致。  

而设置 RouterOS 流量整形的目的就是尽可能的不触发运营商的 QoS。设置思路也很简单，首先在 RouterOS 中设置一个合理的带宽用量上限，然后通过 RouterOS 的流量整形算法，根据不同内网设备的流量需求，均衡合理的动态分配内网带宽，以保证整体内网的网络服务质量，也就是内网的 QoS。  

参考 OpenWrt 官方文档《[SQM (Smart Queue Management)](https://openwrt.org/docs/guide-user/network/traffic-shaping/sqm)》 和《[SQM Details](https://openwrt.org/docs/guide-user/network/traffic-shaping/sqm-details)》，里面详细介绍了如何微调参数。我这里结合实际情况，将带宽部分总结如下：

![带宽确认](img/p2/bandwidth_confirm.png)

一句话说明：签约带宽比物理接口速率高，则带宽上限取物理接口速率；签约带宽比物理接口速率低，且完全可以跑出超过签约带宽的实际速率，则带宽上限取实际速率的平均值。  

**注意：**  
**带宽测速一定要使用网线连接路由器，并且断开其他连接路由器的用网设备，以保证带宽测速的准确性。**  

如果实际带宽速率比签约带宽要低，建议检查光猫性能、光衰情况、网线质量、软路由的CPU分配是否合适，如果这些都没问题，那就是运营商问题，可以打电话给运营商并要求上门维修。  

**当然，为了省事，也可以直接取签约带宽的速率值为带宽上限值。**  

在拿到带宽上限后，分别乘以 `95%` 、 `90%` 、 `85%` ，得到包含带宽上限在内的共计四个档位的速率，留下备用，比如：  

下行带宽上限为 `500Mbps`，得到 `475Mbps` 、 `450Mbps` 、 `425Mbps` 共四个个档位的速率。  

上行带宽上限为 `50Mbps`，得到 `48Mbps` 、 `45Mbps` 、 `43Mbps` 共四个档位的速率。  

### 4.3.配置流量整形